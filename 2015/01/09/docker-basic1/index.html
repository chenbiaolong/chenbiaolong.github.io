
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>docker 基础工作原理（一） | chenbiaolong&#39;s blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="chenbiaolong">
    
    <meta name="description" content="概述
相信很多人和我一样，初学docker时一直无法搞懂docker镜像的工作机理。这几天对docker如何工作进行了一番研究，简单整理一下。docker的两大核心基础技术是namespace和cgroup，cgroup主要作资源的限制隔离，它可以限制一组进程中能使用的最大资源使用量，相对比较好理解；namespace同样可以实现资源隔离，不同的是它是通过使PID,IPC,Network等系统资源不再是全局性的，而是属于特定的Namespace实现的。每个Namespace里面的资源对其他Namespace都是透明的，这个概念有点类似于linux的多用户机制。">
    
    
    <meta name="description" content="概述
相信很多人和我一样，初学docker时一直无法搞懂docker镜像的工作机理。这几天对docker如何工作进行了一番研究，简单整理一下。docker的两大核心基础技术是namespace和cgroup，cgroup主要作资源的限制隔离，它可以限制一组进程中能使用的最大资源使用量，相对比较好理解；namespace同样可以实现资源隔离，不同的是它是通过使PID,IPC,Network等系统资源">
<meta property="og:type" content="article">
<meta property="og:title" content="docker 基础工作原理（一）">
<meta property="og:url" content="http://chenbiaolong.com/2015/01/09/docker-basic1/">
<meta property="og:site_name" content="chenbiaolong's blog">
<meta property="og:description" content="概述
相信很多人和我一样，初学docker时一直无法搞懂docker镜像的工作机理。这几天对docker如何工作进行了一番研究，简单整理一下。docker的两大核心基础技术是namespace和cgroup，cgroup主要作资源的限制隔离，它可以限制一组进程中能使用的最大资源使用量，相对比较好理解；namespace同样可以实现资源隔离，不同的是它是通过使PID,IPC,Network等系统资源">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="docker 基础工作原理（一）">
<meta name="twitter:description" content="概述
相信很多人和我一样，初学docker时一直无法搞懂docker镜像的工作机理。这几天对docker如何工作进行了一番研究，简单整理一下。docker的两大核心基础技术是namespace和cgroup，cgroup主要作资源的限制隔离，它可以限制一组进程中能使用的最大资源使用量，相对比较好理解；namespace同样可以实现资源隔离，不同的是它是通过使PID,IPC,Network等系统资源">


    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

</head>

  <body>
    <header>
      <div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="chenbiaolong&#39;s blog">chenbiaolong&#39;s blog</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives">存档</a></li>
					
						<li><a href="/about">about</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:chenbiaolong.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/01/09/docker-basic1/" title="docker 基础工作原理（一）" itemprop="url">docker 基础工作原理（一）</a>
  </h1>
  <p class="article-author">By
       
		<a href="http://chenbiaolong.com/about" title="chenbiaolong" target="_blank" itemprop="author">chenbiaolong</a>
		
  <p class="article-time">
    <time datetime="2015-01-09T07:30:41.000Z" itemprop="datePublished"> Published Jan 9 2015</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#概述"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#利用chroot和busybox实现文件系统隔离"><span class="toc-number">2.</span> <span class="toc-text">利用chroot和busybox实现文件系统隔离</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#namespace隔离"><span class="toc-number">3.</span> <span class="toc-text">namespace隔离</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#busybox_基础镜像制作"><span class="toc-number">4.</span> <span class="toc-text">busybox 基础镜像制作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li></ol>
		
		</div>
		
		<h2 id="概述">概述</h2>
<p>相信很多人和我一样，初学docker时一直无法搞懂docker镜像的工作机理。这几天对docker如何工作进行了一番研究，简单整理一下。<br>docker的两大核心基础技术是<a href="http://lwn.net/Articles/531114/" target="_blank" rel="external">namespace</a>和cgroup，cgroup主要作资源的限制隔离，它可以限制一组进程中能使用的最大资源使用量，相对比较好理解；namespace同样可以实现资源隔离，不同的是它是通过使PID,IPC,Network等系统资源不再是全局性的，而是属于特定的Namespace实现的。每个Namespace里面的资源对其他Namespace都是透明的，这个概念有点类似于linux的多用户机制。<br><a id="more"></a><br>namespace的详细介绍可以参考<a href="https://blog.jtlebi.fr/2013/12/22/introduction-to-linux-namespaces-part-1-uts/" target="_blank" rel="external">Introduction to Linux namespaces</a>系列文章，国内已经有人对这系列博文进行了翻译：<a href="http://blog.lucode.net/linux/intro-Linux-namespace-1.html" target="_blank" rel="external">linux namespace简介</a>，本文接下来对namepace的介绍主要参考以上两篇博文。<br>现在linux内核中支持的namespace主要有：</p>
<blockquote>
<ul>
<li>Mount namespaces (CLONE_NEWNS)<br>isolate the set of filesystem mount points seen by a group of processes. Thus, processes in different mount namespaces can have different views of the filesystem hierarchy. With the addition of mount namespaces, the mount() and umount() system calls ceased operating on a global set of mount points visible to all processes on the system and instead performed operations that affected just the mount namespace associated with the calling process. </li>
<li>UTS namespaces(CLONE_NEWUTS)<br>isolate two system identifiers—nodename and domainname—returned by the uname() system call; the names are set using the sethostname() and setdomainname() system calls. In the context of containers, the UTS namespaces feature allows each container to have its own hostname and NIS domain name. This can be useful for initialization and configuration scripts that tailor their actions based on these names. The term “UTS” derives from the name of the structure passed to the uname() system call: struct utsname. The name of that structure in turn derives from “UNIX Time-sharing System”</li>
<li>IPC namespaces (CLONE_NEWIPC)<br>isolate certain interprocess communication (IPC) resources, namely, System V IPC objects and (since Linux 2.6.30) POSIX message queues. The common characteristic of these IPC mechanisms is that IPC objects are identified by mechanisms other than filesystem pathnames. Each IPC namespace has its own set of System V IPC identifiers and its own POSIX message queue filesystem. </li>
<li>PID namespaces (CLONE_NEWPID, Linux 2.6.24)<br>isolate the process ID number space. In other words, processes in different PID namespaces can have the same PID. One of the main benefits of PID namespaces is that containers can be migrated between hosts while keeping the same process IDs for the processes inside the container. PID namespaces also allow each container to have its own init (PID 1), the “ancestor of all processes” that manages various system initialization tasks and reaps orphaned child processes when they terminate. </li>
<li>Network namespaces (CLONE_NEWNET, started in Linux 2.4.19 2.6.24 and largely completed by about Linux 2.6.29)<br>provide isolation of the system resources associated with networking. Thus, each network namespace has its own network devices, IP addresses, IP routing tables, /proc/net directory, port numbers, and so on.Network namespaces make containers useful from a networking perspective: each container can have its own (virtual) network device and its own applications that bind to the per-namespace port number space; suitable routing rules in the host system can direct network packets to the network device associated with a specific container. Thus, for example, it is possible to have multiple containerized web servers on the same host system, with each server bound to port 80 in its (per-container) network namespace. </li>
<li>User namespaces (CLONE_NEWUSER, started in Linux 2.6.23 and completed in Linux 3.8)<br>isolate the user and group ID number spaces. In other words, a process’s user and group IDs can be different inside and outside a user namespace. The most interesting case here is that a process can have a normal unprivileged user ID outside a user namespace while at the same time having a user ID of 0 inside the namespace. This means that the process has full root privileges for operations inside the user namespace, but is unprivileged for operations outside the namespace. </li>
</ul>
</blockquote>
<p>在这篇博文中，将主要介绍PID namespace和mount namepace。通过这两个namespace模拟docker在基础文件系统中运行的原理。我们将利用busybox建立一个可以满足linux系统运行的基础环境，并且通过chroot切换根目录，实现环境隔离。</p>
<h2 id="利用chroot和busybox实现文件系统隔离">利用chroot和busybox实现文件系统隔离</h2>
<p>chroot可以实现根路径的切换，但如果新的根路径环境下没有基础库和程序（比如bash），那么chroot将不能正常切换根路径。busybox提供了能保证linux系统正常运行的基础工具（如bash、ls等命令工具），我们可以利用chroot+busybox在我们本地系统中建立一个新的沙箱系统（当然此时并没有名字空间的隔离，只是根文件系统实现了隔离）。<br>首先从官方<a href="http://www.busybox.net/downloads/" target="_blank" rel="external">下载busybox的源码</a>，这里我使用的是1.22版本。解压后直接使用默认配置,然后运行make,make install。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root<span class="variable">@localhost</span> busybox-<span class="number">1.22</span>.<span class="number">1</span>]<span class="comment"># make defconfig #使用默认配置</span></div><div class="line">[root<span class="variable">@localhost</span> busybox-<span class="number">1.22</span>.<span class="number">1</span>]<span class="comment"># make</span></div><div class="line">[root<span class="variable">@localhost</span> busybox-<span class="number">1.22</span>.<span class="number">1</span>]<span class="comment"># make install</span></div></pre></td></tr></table></figure>

<p>一切顺利的话，系统会在当前路径下生成一个_install文件夹。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root<span class="variable">@localhost</span> busybox-<span class="number">1.22</span>.<span class="number">1</span>] cd _install</div><div class="line">[root<span class="variable">@localhost</span> _install]<span class="comment">#ls</span></div><div class="line">bin  linuxrc  sbin  usr</div></pre></td></tr></table></figure>

<p>_install 文件夹中包含了许多基础工具</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@localhost _install]# <span class="keyword">cd</span> bin</div><div class="line">[root@localhost bin]# <span class="keyword">ls</span></div><div class="line">ash      chgrp   cttyhack       dumpkmap  fgrep   <span class="built_in">hostname</span>  kill     lsattr    more     netstat        printenv   rmdir         setserial  <span class="keyword">sync</span>    usleep</div><div class="line">base64   chmod   date           <span class="keyword">echo</span>      fsync   hush      linux32  lzop      mount       nice           <span class="keyword">ps</span>         rpm           <span class="keyword">sh</span>         tar     <span class="keyword">vi</span></div><div class="line">busybox  chown   dd             ed        getopt  ionice    linux64  makemime  mountpoint  pidof          <span class="keyword">pwd</span>        run-parts     <span class="keyword">sleep</span>      touch   watch</div><div class="line"><span class="keyword">cat</span>      conspy  df             egrep     <span class="keyword">grep</span>    iostat    <span class="keyword">ln</span>       <span class="built_in">mkdir</span>     mpstat      ping           reformime  scriptreplay  stat       true    zcat</div><div class="line">catv     <span class="keyword">cp</span>      dmesg          false     gunzip  ipcalc    login    mknod     mt          ping6          rev        sed           stty       umount</div><div class="line">chattr   cpio    dnsdomainname  fdflush   gzip    kbd_mode  <span class="keyword">ls</span>       mktemp    mv          pipe_progress  rm         setarch       su         uname</div></pre></td></tr></table></figure>

<p>返回_install路径，尝试进行chroot</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root<span class="variable">@localhost</span> bin]<span class="comment"># cd ..</span></div><div class="line">[root<span class="variable">@localhost</span> _install]<span class="comment"># chroot . /bin/ash</span></div><div class="line"><span class="keyword">chroot</span>: failed to run command ‘/bin/ash’: No such file <span class="keyword">or</span> directory</div><div class="line">[root<span class="variable">@localhost</span> _install]<span class="comment">#</span></div></pre></td></tr></table></figure>

<p>这里提示没有找到/bin/ash，但实际上bin文件夹的ash是存在的。这里主要原因是切换根路径后，系统无法找到busybox依赖的动态链接库,busybox无法正常工作。先看一下busybox依赖的库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root<span class="property">@localhost</span> _install]<span class="comment"># ldd /bin/busybox </span></div><div class="line">	linux-vdso.so<span class="number">.1</span><span class="function"> =&gt;</span>  (<span class="number">0x00007fff415fa000</span>)</div><div class="line">	libm.so<span class="number">.6</span><span class="function"> =&gt;</span> /lib64/libm.so<span class="number">.6</span> (<span class="number">0x00007f53f4926000</span>)</div><div class="line">	libc.so<span class="number">.6</span><span class="function"> =&gt;</span> /lib64/libc.so<span class="number">.6</span> (<span class="number">0x00007f53f4565000</span>)</div><div class="line">	/lib64/ld-linux-x86-<span class="number">64.</span>so<span class="number">.2</span> (<span class="number">0x00007f53f4c3d000</span>)</div><div class="line">[root<span class="property">@localhost</span> _install]<span class="comment"># mkdir lib64</span></div><div class="line">[root<span class="property">@localhost</span> _install]<span class="comment"># cp /lib64/libm.so.6 ./lib64/</span></div><div class="line">[root<span class="property">@localhost</span> _install]<span class="comment"># cp /lib64/libc.so.6 ./lib64/</span></div><div class="line">[root<span class="property">@localhost</span> _install]<span class="comment"># cp /lib64/ld-linux-x86-64.so.2 ./lib64</span></div><div class="line">[root<span class="property">@localhost</span> _install]<span class="comment"># chroot . /bin/ash</span></div><div class="line">/ <span class="comment"># ls</span></div><div class="line">bin      lib64    linuxrc  sbin     usr</div><div class="line">/ <span class="comment">#</span></div></pre></td></tr></table></figure>

<p>从11行起可以看出chroot已经成功完成根路径切换，现在运行在busybox搭建的根路径环境下。<br>但实际上现在根路径并不是完整的，可以看出busybox搭建的根文件系统并没有/proc和/dev等目录，在该环境下允许top等指令并不能正常允许。接下来是namespace发挥作用的时候了。</p>
<h2 id="namespace隔离">namespace隔离</h2>
<p>以下内容主要来源于<a href="http://blog.lucode.net/linux/intro-Linux-namespace-1.html" target="_blank" rel="external">linux namespace简介</a>系列文章。这里我们直接使用文中的测试代码。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//namespace.c</span></div><div class="line"><span class="preprocessor">#<span class="keyword">define</span> _GNU_SOURCE</span></div><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;sys/types.h&gt;</span></div><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;sys/wait.h&gt;</span></div><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;sys/mount.h&gt;</span></div><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;sched.h&gt;</span></div><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;signal.h&gt;</span></div><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;unistd.h&gt;</span></div><div class="line"><span class="preprocessor">#<span class="keyword">define</span> STACK_SIZE (1024 * 1024)</span></div><div class="line"><span class="comment">// sync primitive</span></div><div class="line"><span class="keyword">int</span> checkpoint[<span class="number">2</span>];</div><div class="line"><span class="keyword">static</span> <span class="keyword">char</span> child_stack[STACK_SIZE];</div><div class="line"><span class="keyword">char</span>* <span class="keyword">const</span> child_args[] = {</div><div class="line">  <span class="string">"/bin/bash"</span>,</div><div class="line">  NULL</div><div class="line">};</div><div class="line"><span class="keyword">int</span> child_main(<span class="keyword">void</span>* arg) {</div><div class="line">  <span class="keyword">char</span> c;</div><div class="line">  <span class="comment">// init sync primitive</span></div><div class="line">  close(checkpoint[<span class="number">1</span>]);</div><div class="line">  <span class="comment">// setup hostname</span></div><div class="line">  <span class="built_in">printf</span>(<span class="string">" - [%5d] World !\n"</span>, getpid());</div><div class="line">  sethostname(<span class="string">"In Namespace"</span>, <span class="number">12</span>);</div><div class="line">  <span class="comment">// wait...</span></div><div class="line">  read(checkpoint[<span class="number">0</span>], &c, <span class="number">1</span>);</div><div class="line">  execv(child_args[<span class="number">0</span>], child_args);</div><div class="line">  <span class="built_in">printf</span>(<span class="string">"Ooops\n"</span>);</div><div class="line">  <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">}</div><div class="line"><span class="keyword">int</span> main() {</div><div class="line">  <span class="comment">// init sync primitive</span></div><div class="line">  pipe(checkpoint);</div><div class="line">  <span class="built_in">printf</span>(<span class="string">" - [%5d] Hello ?\n"</span>, getpid());</div><div class="line">  <span class="keyword">int</span> child_pid = clone(child_main, child_stack+STACK_SIZE,</div><div class="line">      CLONE_NEWUTS | CLONE_NEWIPC | CLONE_NEWPID | CLONE_NEWNS | SIGCHLD, NULL);</div><div class="line">  <span class="comment">// further init here (nothing yet)</span></div><div class="line">  <span class="comment">// signal "done"</span></div><div class="line">  close(checkpoint[<span class="number">1</span>]);</div><div class="line">  waitpid(child_pid, NULL, <span class="number">0</span>);</div><div class="line">  <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>编译namespace.c，建立一个proc的空文件夹。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root<span class="variable">@localhost</span> _install]<span class="comment"># mkdir proc</span></div><div class="line">[root<span class="variable">@localhost</span> _install]<span class="comment"># gcc namespace.c -o ns</span></div><div class="line">[root<span class="variable">@localhost</span> _install]<span class="comment">#</span></div></pre></td></tr></table></figure>

<p>执行ns进入新的名字空间，chroot将根目录切换到当前目录下。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root<span class="variable">@localhost</span> _install]<span class="comment"># ./ns</span></div><div class="line"> - [<span class="number">14649</span>] <span class="constant">Hello</span> ?</div><div class="line"> - [    <span class="number">1</span>] <span class="constant">World</span> !</div><div class="line">[root<span class="variable">@In</span> <span class="constant">Namespace</span> _install]<span class="comment"># chroot . /bin/ash</span></div><div class="line">/ <span class="comment"># </span></div><div class="line">/ <span class="comment"># ps #这个ps没有获得任何进程数据，因为当前/proc为空文件夹</span></div><div class="line"><span class="constant">PID</span>   <span class="constant">USER</span>     <span class="constant">TIME</span>   <span class="constant">COMMAND</span></div><div class="line">/ <span class="comment"># mount -t proc proc /proc #将当前名字空间的proc文件系统挂在到/proc</span></div><div class="line">/ <span class="comment"># ps #获得当前名字空间的进程数据</span></div><div class="line"><span class="constant">PID</span>   <span class="constant">USER</span>     <span class="constant">TIME</span>   <span class="constant">COMMAND</span></div><div class="line">    <span class="number">1</span> <span class="number">0</span>          <span class="number">0</span><span class="symbol">:</span><span class="number">00</span> /bin/bash</div><div class="line">   <span class="number">30</span> <span class="number">0</span>          <span class="number">0</span><span class="symbol">:</span><span class="number">00</span> /bin/ash</div><div class="line">   <span class="number">33</span> <span class="number">0</span>          <span class="number">0</span><span class="symbol">:</span><span class="number">00</span> ps</div><div class="line">/ <span class="comment">#</span></div></pre></td></tr></table></figure>

<p>现在在当前根路径下已经基本实现了名字空间的隔离和文件系统的隔离，一个沙箱系统的雏形已经实现。docker的运行的基础原理也大致如此，不过现在还没有添加进cgroup。</p>
<h2 id="busybox_基础镜像制作">busybox 基础镜像制作</h2>
<p>现在考虑将当前的busybox环境打成一个基础镜像。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root<span class="variable">@localhost</span> _install]<span class="comment"># tar --numeric-owner -cvf  ../BusyBox-test.tar ./</span></div></pre></td></tr></table></figure>

<p>注意，此时的BusyBox-test.tar文件只是一个tar包，里面缺乏docker需要的一些json文件和目录，并不能直接用docker load倒入。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root<span class="property">@localhost</span> busybox-<span class="number">1.22</span><span class="number">.1</span>]<span class="comment"># docker load &lt; BusyBox-test.tar</span></div><div class="line"><span class="number">2015</span>/<span class="number">01</span>/<span class="number">09</span> <span class="number">13</span>:<span class="number">01</span>:<span class="number">51</span> <span class="attribute">Error</span>: open /<span class="reserved">var</span>/lib/docker/tmp/docker-<span class="reserved">import</span>-<span class="number">114653123</span>/repo/bin/<span class="attribute">json</span>: <span class="literal">no</span> such file <span class="keyword">or</span> directory</div><div class="line">[root<span class="property">@localhost</span> busybox-<span class="number">1.22</span><span class="number">.1</span>]<span class="comment">#</span></div></pre></td></tr></table></figure>

<p>可以使用以下指令导入镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root<span class="variable">@localhost</span> busybox-<span class="number">1.22</span>.<span class="number">1</span>]<span class="comment"># cat BusyBox-test.tar | docker import - busyboxtest</span></div><div class="line"><span class="number">3341</span>f4c8d8326866a15099dd09cff11d3f09c07d50c4d0dec9930b26dfa11b2a</div><div class="line">[root<span class="variable">@localhost</span> busybox-<span class="number">1.22</span>.<span class="number">1</span>]<span class="comment"># docker images</span></div><div class="line"><span class="constant">REPOSITORY</span>          <span class="constant">TAG</span>                 <span class="constant">IMAGE</span> <span class="constant">ID</span>            <span class="constant">CREATED</span>             <span class="constant">VIRTUAL</span> <span class="constant">SIZE</span></div><div class="line">busyboxtest         latest              <span class="number">3341</span>f4c8d832        <span class="number">19</span> minutes ago      <span class="number">4.241</span> <span class="constant">MB</span></div><div class="line">centos              <span class="number">7</span>                   <span class="number">8</span>efe422e6104        <span class="number">3</span> days ago          <span class="number">224</span> <span class="constant">MB</span></div><div class="line">centos              centos7             <span class="number">8</span>efe422e6104        <span class="number">3</span> days ago          <span class="number">224</span> <span class="constant">MB</span></div><div class="line">centos              latest              <span class="number">8</span>efe422e6104        <span class="number">3</span> days ago          <span class="number">224</span> <span class="constant">MB</span></div><div class="line">busybox             buildroot-<span class="number">2014.02</span>   <span class="number">4986</span>bf8c1536        <span class="number">8</span> days ago          <span class="number">2.433</span> <span class="constant">MB</span></div><div class="line">busybox             latest              <span class="number">4986</span>bf8c1536        <span class="number">8</span> days ago          <span class="number">2.433</span> <span class="constant">MB</span></div></pre></td></tr></table></figure>

<p>运行docker，查看镜像是否能正常运行。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@localhost busybox-<span class="number">1</span>.<span class="number">22</span>.<span class="number">1</span>]<span class="comment"># docker run -it  busyboxtest /bin/sh</span></div><div class="line">/ <span class="comment"># ls</span></div><div class="line">bin  dev etc lib64  linuxrc namespace.c  ns  <span class="keyword">proc</span>   sbin    sys  usr</div><div class="line">/ <span class="comment">#</span></div></pre></td></tr></table></figure>

<p>可以看出镜像能正常运行。将busyboxtest镜像导出，看镜像文件和简单的tar文件有何不同。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@localhost _install]<span class="comment"># docker save busyboxtest &gt; busyboxtest-img.tar</span></div><div class="line">[root@localhost _install]<span class="comment"># ls</span></div><div class="line">bin  lib64  linuxrc  busyboxtest-img.tar  namespace.c  ns  <span class="keyword">proc</span>  sbin  usr</div></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root<span class="variable">@localhost</span> _install]<span class="comment"># mkdir img</span></div><div class="line">[root<span class="variable">@localhost</span> _install]<span class="comment"># cp busyboxtest-img.tar img</span></div><div class="line">[root<span class="variable">@localhost</span> _install]<span class="comment"># cd img</span></div><div class="line">[root<span class="variable">@localhost</span> img]<span class="comment"># ls</span></div><div class="line">busyboxtest-img.tar</div><div class="line">[root<span class="variable">@localhost</span> img]<span class="comment"># tar xvf busyboxtest-img.tar </span></div><div class="line"><span class="number">3341</span>f4c8d8326866a15099dd09cff11d3f09c07d50c4d0dec9930b26dfa11b2a/</div><div class="line"><span class="number">3341</span>f4c8d8326866a15099dd09cff11d3f09c07d50c4d0dec9930b26dfa11b2a/<span class="constant">VERSION</span></div><div class="line"><span class="number">3341</span>f4c8d8326866a15099dd09cff11d3f09c07d50c4d0dec9930b26dfa11b2a/json</div><div class="line"><span class="number">3341</span>f4c8d8326866a15099dd09cff11d3f09c07d50c4d0dec9930b26dfa11b2a/layer.tar</div><div class="line">repositories</div></pre></td></tr></table></figure>

<p>在镜像文件夹中，layer实际上就是我们打包的tar文件。docker import进tar文件后对tar文件进行了一些处理，方便docker对镜像文件进行管理。<br>接下来我们对busyboxtest进行修改，往根目录里添加一个文本文件，并将修改后的镜像命名为busyboxtest:v1，解压镜像文件后看文件夹里的内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">[root@localhost img2]<span class="comment"># tar xvf busyboxtestv1.tar </span></div><div class="line"><span class="number">3341</span>f4c8d8326866a15099dd09cff11d3f09c07d50c4d0dec9930b26dfa11b2a/</div><div class="line"><span class="number">3341</span>f4c8d8326866a15099dd09cff11d3f09c07d50c4d0dec9930b26dfa11b2a/VERSION</div><div class="line"><span class="number">3341</span>f4c8d8326866a15099dd09cff11d3f09c07d50c4d0dec9930b26dfa11b2a/json</div><div class="line"><span class="number">3341</span>f4c8d8326866a15099dd09cff11d3f09c07d50c4d0dec9930b26dfa11b2a/layer.tar</div><div class="line"><span class="number">8</span>d24158476ecbdea530dc210bda9b60970dd809d10a914ae19c83e8359396653/</div><div class="line"><span class="number">8</span>d24158476ecbdea530dc210bda9b60970dd809d10a914ae19c83e8359396653/VERSION</div><div class="line"><span class="number">8</span>d24158476ecbdea530dc210bda9b60970dd809d10a914ae19c83e8359396653/json</div><div class="line"><span class="number">8</span>d24158476ecbdea530dc210bda9b60970dd809d10a914ae19c83e8359396653/layer.tar</div><div class="line">repositories</div><div class="line">[root@localhost img2]<span class="comment"># tree</span></div><div class="line">.</div><div class="line">|<span class="comment">-- 3341f4c8d8326866a15099dd09cff11d3f09c07d50c4d0dec9930b26dfa11b2a</span></div><div class="line">|   |<span class="comment">-- json</span></div><div class="line">|   |<span class="comment">-- layer.tar</span></div><div class="line">|   `<span class="comment">-- VERSION</span></div><div class="line">|<span class="comment">-- 8d24158476ecbdea530dc210bda9b60970dd809d10a914ae19c83e8359396653</span></div><div class="line">|   |<span class="comment">-- json</span></div><div class="line">|   |<span class="comment">-- layer.tar</span></div><div class="line">|   `<span class="comment">-- VERSION</span></div><div class="line">|<span class="comment">-- busyboxtestv1.tar</span></div><div class="line">`<span class="comment">-- repositories</span></div><div class="line">[root@localhost img2]<span class="comment"># tree</span></div><div class="line">.</div><div class="line">|<span class="comment">-- 3341f4c8d8326866a15099dd09cff11d3f09c07d50c4d0dec9930b26dfa11b2a</span></div><div class="line">|   |<span class="comment">-- json</span></div><div class="line">|   |<span class="comment">-- layer.tar</span></div><div class="line">|   `<span class="comment">-- VERSION</span></div><div class="line">|<span class="comment">-- 8d24158476ecbdea530dc210bda9b60970dd809d10a914ae19c83e8359396653</span></div><div class="line">|   |<span class="comment">-- json</span></div><div class="line">|   |<span class="comment">-- layer.tar</span></div><div class="line">|   `<span class="comment">-- VERSION</span></div><div class="line">|<span class="comment">-- busyboxtestv1.tar</span></div><div class="line">`<span class="comment">-- repositories</span></div><div class="line"></div><div class="line"><span class="number">2</span> directories, <span class="number">8</span> files</div><div class="line">[root@localhost img2]<span class="comment">#</span></div></pre></td></tr></table></figure>

<p>3341f…这个文件夹保存的是未修改的镜像信息，8d24…文件保存的是修改信息，它只保存和基础镜像的diff信息，具体存储在该文件夹的layer.tar文件。解压8d24…文件夹的layer.tar文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root<span class="variable">@localhost</span> <span class="number">8</span>d24158476ecbdea530dc210bda9b60970dd809d10a914ae19c83e8359396653]<span class="comment"># ls</span></div><div class="line">json  layer.tar  <span class="constant">VERSION</span></div><div class="line">[root<span class="variable">@localhost</span> <span class="number">8</span>d24158476ecbdea530dc210bda9b60970dd809d10a914ae19c83e8359396653]<span class="comment"># tar xvf layer.tar </span></div><div class="line">.ash_history</div><div class="line">img_test_file</div><div class="line">[root<span class="variable">@localhost</span> <span class="number">8</span>d24158476ecbdea530dc210bda9b60970dd809d10a914ae19c83e8359396653]<span class="comment"># ls</span></div><div class="line">img_test_file  json  layer.tar  <span class="constant">VERSION</span></div><div class="line">[root<span class="variable">@localhost</span> <span class="number">8</span>d24158476ecbdea530dc210bda9b60970dd809d10a914ae19c83e8359396653]<span class="comment">#</span></div></pre></td></tr></table></figure>

<p>可以看出里面多了一个img_test_file文件，这个正是我们在基础镜像里添加的文件。.ash_history保存的是命令执行历史记录:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@localhost <span class="number">8</span>d24158476ecbdea530dc210bda9b60970dd809d10a914ae19c83e8359396653]# <span class="keyword">cat</span> .ash_history </div><div class="line"><span class="keyword">ls</span></div><div class="line"><span class="keyword">vi</span> img_test_file</div><div class="line"><span class="keyword">ls</span></div><div class="line"><span class="keyword">exit</span></div><div class="line">[root@localhost <span class="number">8</span>d24158476ecbdea530dc210bda9b60970dd809d10a914ae19c83e8359396653]#</div></pre></td></tr></table></figure>

<p>docker可以根据这个diff信息构建出新的工作环境。</p>
<h2 id="总结">总结</h2>
<p>docker实现资源隔离的两大linux基础技术是:namespace和cgroup。并且通过chroot实现运行的根目录环境切换。在这篇博文中主要简单模拟了docker的namespace和chroot工作流程，并且介绍了制作基础镜像的过程。本篇博文只是很概要的模拟docker工作原理，具体的详细流程需要继续分析docker的源码。</p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/docker/">docker</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/docker-基础工作原理/">docker 基础工作原理</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://chenbiaolong.com/2015/01/09/docker-basic1/" data-title="docker 基础工作原理（一） | chenbiaolong&#39;s blog" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">




</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2015/01/09/docker-basic1/" data-title="docker 基础工作原理（一）" data-url="http://chenbiaolong.com/2015/01/09/docker-basic1/"></div>
</section>


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#概述"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#利用chroot和busybox实现文件系统隔离"><span class="toc-number">2.</span> <span class="toc-text">利用chroot和busybox实现文件系统隔离</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#namespace隔离"><span class="toc-number">3.</span> <span class="toc-text">namespace隔离</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#busybox_基础镜像制作"><span class="toc-number">4.</span> <span class="toc-text">busybox 基础镜像制作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
			<li><a href="/categories/docker/" title="docker">docker<sup>5</sup></a></li>
		
			<li><a href="/categories/大数据/" title="大数据">大数据<sup>1</sup></a></li>
		
			<li><a href="/categories/第三方软件/" title="第三方软件">第三方软件<sup>1</sup></a></li>
		
		</ul>
</div>



  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/docker-基础工作原理/" title="docker 基础工作原理">docker 基础工作原理<sup>5</sup></a></li>
		
			<li><a href="/tags/protobuf/" title="protobuf">protobuf<sup>1</sup></a></li>
		
			<li><a href="/tags/hadoop/" title="hadoop">hadoop<sup>1</sup></a></li>
		
			<li><a href="/tags/spring/" title="spring">spring<sup>1</sup></a></li>
		
		</ul>
</div>



  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.zybuluo.com/mdeditor" target="_blank" title="在线markdown工具">在线markdown工具</a>
            
          </li>
        
          <li>
            
            	<a href="http://lxr.free-electrons.com/ident" target="_blank" title="linux内核代码检索">linux内核代码检索</a>
            
          </li>
        
    </ul>
</div>


  


</aside>
</div>
    </div>
    <footer><div id="footer" >

	
	
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://zespia.tw/hexo/" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Pacman">Jacman</a> © 2015 
		
		<a href="http://chenbiaolong.com/about" target="_blank" title="chenbiaolong">chenbiaolong</a>
		
		<!-- Analytics Begin -->
		


<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fd945ed3061f3e880f79e49bd827e29c0' type='text/javascript'%3E%3C/script%3E"));
</script>



		<!-- Analytics End -->
		</p>
</div>
</footer>
    
<script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>




<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#nothing"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>



<script type="text/javascript">
  var duoshuoQuery = {short_name:"chenbiaolong"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 










<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

  </body>
</html>
